apiVersion: secrets.lux.network/v1alpha1
kind: KMSSecret
metadata:
  name: {{iid}}-kms-sync
  namespace: {{namespace}}
spec:
  hostAPI: https://kms.hanzo.ai
  resyncInterval: 60
  authentication:
    universalAuth:
      credentialsRef:
        secretName: flow-kms-auth
        secretNamespace: {{namespace}}
      secretsScope:
        projectSlug: flow
        envSlug: production
        secretsPath: /orgs/{{namespace}}/flows/{{iid}}
  managedSecretReference:
    secretName: {{iid}}-flow-secrets
    secretNamespace: {{namespace}}
    secretType: Opaque

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{iid}}
  namespace: {{namespace}}
spec:
  replicas: {{deploymentConfig.desiredReplicas}}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: {{iid}}
  template:
    metadata:
      labels:
        app: {{iid}}
      annotations:
        secrets.lux.network/auto-reload: "true"
        secrets.lux.network/managed-secret: "{{iid}}-flow-secrets"
    spec:
      restartPolicy: Always
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: flow
          image: {{registry.imageUrl}}
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: {{networking.containerPort}}
              name: http
          env:
            - name: FLOW_HOST
              value: "0.0.0.0"
            - name: FLOW_PORT
              value: "7860"
            - name: FLOW_AUTO_LOGIN
              value: "false"
            - name: FLOW_CONFIG_DIR
              value: "/app/flow"
            - name: FLOW_SSO_ENABLED
              value: "true"
            - name: FLOW_SSO_PROVIDER
              value: "oidc"
            - name: FLOW_OIDC_ISSUER_URL
              value: http://iam.hanzo.svc.cluster.local
            - name: FLOW_LLM_GATEWAY_URL
              value: http://gateway.hanzo.svc.cluster.local:8080/v1
            - name: HANZO_IAM_URL
              value: http://iam.hanzo.svc.cluster.local
            - name: {{variables.0.name}}
              value: "{{variables.0.value}}"
            - name: {{variables.1.name}}
              value: "{{variables.1.value}}"
            - name: {{variables.2.name}}
              value: "{{variables.2.value}}"
            - name: {{variables.3.name}}
              value: "{{variables.3.value}}"
            - name: {{variables.4.name}}
              value: "{{variables.4.value}}"
            - name: {{variables.5.name}}
              value: "{{variables.5.value}}"
            - name: {{variables.6.name}}
              value: "{{variables.6.value}}"
            - name: {{variables.7.name}}
              value: "{{variables.7.value}}"
          envFrom:
            - secretRef:
                name: {{iid}}-flow-secrets
                optional: true
          resources:
            requests:
              memory: {{podConfig.memoryRequest}}{{podConfig.memoryRequestType}}
              cpu: {{podConfig.cpuRequest}}{{podConfig.cpuRequestType}}
            limits:
              memory: {{podConfig.memoryLimit}}{{podConfig.memoryLimitType}}
              cpu: {{podConfig.cpuLimit}}{{podConfig.cpuLimitType}}
          startupProbe:
            httpGet:
              path: /health
              port: {{networking.containerPort}}
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
          livenessProbe:
            httpGet:
              path: /health
              port: {{networking.containerPort}}
            failureThreshold: 5
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: {{networking.containerPort}}
            failureThreshold: 5
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5

---

apiVersion: v1
kind: Service
metadata:
  name: {{iid}}
  namespace: {{namespace}}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: {{networking.containerPort}}
      name: http
  selector:
    app: {{iid}}
